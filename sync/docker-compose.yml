services:
  primary:
    hostname: 'primary'
    image: crunchydata/crunchy-postgres:centos7-11.4-2.4.1
    environment:
    - PGHOST=/tmp
    - MAX_CONNECTIONS=10
    - MAX_WAL_SENDERS=5
    - PG_MODE=primary
    - PG_PRIMARY_USER=primaryuser
    - PG_PRIMARY_PASSWORD=password
    - PG_DATABASE=testdb
    - PG_USER=testuser
    - PG_PASSWORD=password
    - PG_ROOT_PASSWORD=password
    - PG_PRIMARY_PORT=5432
    volumes:
         - type: volume
        source: codebase-primary
    ports:
    - "32768:5432"
    networks:
	  - default
    restart: 
        unless-stopped
    deploy:
      placement:
        constraints:
        - node.labels.type == primary
        - node.role == worker
  replica:
    image: crunchydata/crunchy-postgres:centos7-11.4-2.4.1
    environment:
    - PGHOST=/tmp
    - MAX_CONNECTIONS=10
    - MAX_WAL_SENDERS=5
    - PG_MODE=replica
    - PG_PRIMARY_HOST=primary
    - PG_PRIMARY_PORT=5432
    - PG_PRIMARY_USER=primaryuser
    - PG_PRIMARY_PASSWORD=password
    - PG_DATABASE=testdb
    - PG_USER=testuser
    - PG_PASSWORD=password
    - PG_ROOT_PASSWORD=password
    volumes:
    - type: volume
        source: codebase-replica
    ports:
    - "32769:5432"
    networks:
	- default
    restart: 
        unless-stopped
    deploy:
      placement:
        constraints:
        - node.labels.type != primary
        - node.role == worker
networks:
  default:

volumes:
  codebase-primary:
    name: codebase-primary
  codebase-replica:
    name: codebase-replica

